<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cicada Audience with Song</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
  <style>
    body {
      background-color: #111;
      margin: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      height: 100vh;
      font-family: 'Courier New', monospace;
    }

    .audience {
      width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      overflow: hidden;
      transition: opacity 2s ease;
    }

    .audience-row {
      position: relative;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      margin-top: -40px;
    }

    .cicadas {
      position: absolute;
      bottom: 25px;
      left: 0;
      right: 0;
      height: 100%;
      background-image: url('audience.png');
      background-repeat: repeat-x;
      background-position: center bottom;
      background-size: auto 100%;
      opacity: 0.9;
      pointer-events: none;
      transition: transform 0.1s ease, opacity 2s ease;
    }

    .chairs {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 25px;
      background: repeating-linear-gradient(
        to right,
        #3b2f2f 0px,
        #3b2f2f 45px,
        #2b2222 45px,
        #2b2222 50px
      );
      border-top: 3px solid #5c4747;
      border-bottom: 2px solid #1a1010;
      opacity: 0.85;
      transition: opacity 2s ease;
    }

    .row1 { height: 160px; z-index: 10; }
    .row1 .cicadas { background-size: auto 160px; opacity: 1; }
    .row2 { height: 140px; z-index: 9; }
    .row2 .cicadas { background-size: auto 140px; opacity: 0.95; }
    .row3 { height: 120px; z-index: 8; }
    .row3 .cicadas { background-size: auto 120px; opacity: 0.9; }
    .row4 { height: 100px; z-index: 7; }
    .row4 .cicadas { background-size: auto 100px; opacity: 0.85; }
    .row5 { height: 80px; z-index: 6; }
    .row5 .cicadas { background-size: auto 80px; opacity: 0.8; }
    .row6 { height: 60px; z-index: 5; }
    .row6 .cicadas { background-size: auto 60px; opacity: 0.75; }
    .row7 { height: 50px; z-index: 4; }
    .row7 .cicadas { background-size: auto 50px; opacity: 0.7; }
    .row8 { height: 40px; z-index: 3; }
    .row8 .cicadas { background-size: auto 40px; opacity: 0.65; }

    .lyrics-container {
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      color: white;
      font-size: 22px;
      line-height: 1.8;
      opacity: 0;
      transition: opacity 1.5s ease;
      width: 80%;
      pointer-events: none;
      z-index: 50;
    }

    .lyrics-line {
      opacity: 0;
      transition: opacity 2s ease;
    }

    .lyrics-line.visible {
      opacity: 1;
    }

    .poem {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: left;
      max-width: 500px;
      padding: 0 20px;
      font-family: serif;
      font-size: 18px;
      line-height: 1.6;
      color: white;
      opacity: 0;
      transition: opacity 2s ease;
      z-index: 60;
      pointer-events: none;
    }

    .poem.visible {
      pointer-events: auto;
    }

    .hover-word {
      cursor: pointer;
      transition: color 0.3s;
      display: inline-block;
      text-decoration: none;
      color: white;
    }

    .hover-word:hover {
      color: #f5f5dc;
      animation: vibrate 0.15s infinite;
    }

    .hover-word.no-buzz {
      color: white;
    }

    .hover-word.no-buzz:hover {
      color: white;
      animation: none;
    }

    .poet-link {
      cursor: pointer;
      transition: color 0.3s;
      display: inline-block;
      text-decoration: none;
      color: white;
      pointer-events: none;
      opacity: 0.5;
    }

    .poet-link.unlocked {
      pointer-events: auto;
      opacity: 1;
    }

    .poet-link.unlocked:hover {
      color: #f5f5dc;
      animation: vibrate 0.15s infinite;
    }

    @keyframes vibrate {
      0% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(-3px, 3px) rotate(-1deg); }
      50% { transform: translate(3px, -3px) rotate(1deg); }
      75% { transform: translate(-3px, -2px) rotate(-1deg); }
      100% { transform: translate(2px, 2px) rotate(1deg); }
    }
  </style>
</head>
<body>
  <div class="audience" id="audienceContainer">
    <div class="audience-row row8"><div class="cicadas"></div><div class="chairs"></div></div>
    <div class="audience-row row7"><div class="cicadas"></div><div class="chairs"></div></div>
    <div class="audience-row row6"><div class="cicadas"></div><div class="chairs"></div></div>
    <div class="audience-row row5"><div class="cicadas"></div><div class="chairs"></div></div>
    <div class="audience-row row4"><div class="cicadas"></div><div class="chairs"></div></div>
    <div class="audience-row row3"><div class="cicadas"></div><div class="chairs"></div></div>
    <div class="audience-row row2"><div class="cicadas"></div><div class="chairs"></div></div>
    <div class="audience-row row1"><div class="cicadas"></div><div class="chairs"></div></div>
  </div>

  <div class="lyrics-container" id="lyricsContainer">
    <div class="lyrics-line" id="line1">Just one week of cicada days, we're losing touch</div>
    <div class="lyrics-line" id="line2">And I know it just feels inhumane to lose this much</div>
    <div class="lyrics-line" id="line3">Our nerves were braided under ceiling stars</div>
    <div class="lyrics-line" id="line4">That were all glow in the dark, hanging over queen-sized</div>
    <div class="lyrics-line" id="line5">Purple waves of ancient chemicals just whisper</div>
  </div>

  <div class="poem" id="poemContainer">
    Sick of his own <a href="face.html" target="_self" class="hover-word" data-page="face">face</a>,<br>
    sick of his <a href="skin.html" target="_self" class="hover-word" data-page="skin">skin</a>, of the <a href="dark.html" target="_self" class="hover-word" data-page="dark">dark</a>,<br>
    he crawls outside himself<br>
    to <a href="sing.html" target="_self" class="hover-word no-buzz" data-page="sing">sing –</a>
    <br><br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="poet.html" target="_self" class="poet-link" id="poetLink">a better poet than most.</a>
  </div>

  <audio id="buzzAudio" src="buzzz.mp3" preload="auto" loop></audio>

  <script>
    let userInput = [];
    let correctSequence = ['d', 'd', 'e', 'g'];
    let gameState = 'playing';
    let cheering = false;
    let cheeringStart = 0;
    let cicadaLayers = [];
    let cheerOffsets = [];

    let crowdSound, buzzSound, songSound;
    let dSound, eSound, gSound;

    // Collect cicada layers
    document.querySelectorAll('.cicadas').forEach(c => {
      cicadaLayers.push(c);
      cheerOffsets.push(Math.random() * 1000);
    });

    function preload() {
      soundFormats('mp3');
      crowdSound = loadSound('crowd.mp3', () => console.log('crowd loaded'), () => console.log('crowd failed'));
      buzzSound = loadSound('buzzz.mp3', () => console.log('buzz loaded'), () => console.log('buzz failed'));
      songSound = loadSound('cicadadays.mp3', () => console.log('song loaded'), () => console.log('song failed'));
      dSound = loadSound('d.mp3', () => console.log('d note loaded'), () => console.log('d note failed'));
      eSound = loadSound('e.mp3', () => console.log('e note loaded'), () => console.log('e note failed'));
      gSound = loadSound('g.mp3', () => console.log('g note loaded'), () => console.log('g note failed'));
    }

    let chords = {
        'd': { name: 'D', frets: [2, 2, 2, 0], color: '#FF6B6B' },
        'e': { name: 'Em', frets: [0, 4, 3, 2], color: '#4ECDC4' },
        'g': { name: 'G', frets: [0, 2, 3, 2], color: '#95E1D3' }
    };
    
    function setup() {
        let cnv = createCanvas(windowWidth, windowHeight);
        cnv.position(0, 0);
        cnv.style('z-index', '100');
        cnv.style('pointer-events', 'none');
        textFont('Courier New');
    }
    
    function draw() {
        clear();
        if (gameState === 'playing') {
            drawChordDiagrams();
            drawSheetMusic();
            drawUserProgress();
        } else if (gameState === 'correct') {
            updateCheering();
        }
    }

    function drawChordDiagrams() {
        let chordKeys = ['d', 'e', 'g'];
        let spacing = width / 4;
        let startX = spacing;
        let y = height * 0.12;
        
        for (let i = 0; i < chordKeys.length; i++) {
            let chord = chords[chordKeys[i]];
            let x = startX + i * spacing;
            
            push();
            translate(x, y);
            fill(255);
            textSize(32);
            textAlign(CENTER);
            text(chord.name, 0, -70);
            
            let fretWidth = 80;
            let fretHeight = 100;
            let stringSpacing = fretWidth / 3;
            let fretSpacing = fretHeight / 4;
            
            stroke(200);
            strokeWeight(2);
            for (let s = 0; s < 4; s++) {
                line(-fretWidth/2 + s * stringSpacing, -fretHeight/2, 
                     -fretWidth/2 + s * stringSpacing, fretHeight/2);
            }
            
            strokeWeight(1);
            for (let f = 0; f <= 4; f++) {
                let lineWeight = f === 0 ? 4 : 1;
                strokeWeight(lineWeight);
                line(-fretWidth/2, -fretHeight/2 + f * fretSpacing,
                     fretWidth/2, -fretHeight/2 + f * fretSpacing);
            }
            
            fill(chord.color);
            noStroke();
            for (let s = 0; s < 4; s++) {
                let fret = chord.frets[s];
                if (fret > 0) {
                    let xPos = -fretWidth/2 + s * stringSpacing;
                    let yPos = -fretHeight/2 + (fret - 0.5) * fretSpacing;
                    ellipse(xPos, yPos, 15);
                } else if (fret === 0) {
                    stroke(chord.color);
                    strokeWeight(2);
                    noFill();
                    let xPos = -fretWidth/2 + s * stringSpacing;
                    ellipse(xPos, -fretHeight/2 - 20, 12);
                }
            }
            pop();
        }
    }
    
    function drawSheetMusic() {
        let y = height * 0.25;
        let staffX = width * 0.2;
        let staffWidth = width * 0.6;
        let lineSpacing = 15;
        
        push();
        stroke(255);
        strokeWeight(1);
        for (let i = 0; i < 5; i++) {
            line(staffX, y + i * lineSpacing, staffX + staffWidth, y + i * lineSpacing);
        }
        
        fill(255);
        noStroke();
        textSize(40);
        textAlign(CENTER, CENTER);
        text('𝄞', staffX + 30, y + lineSpacing * 2);
        
        let notePositions = [
            {x: staffX + 120, y: y + lineSpacing * 4},
            {x: staffX + 220, y: y + lineSpacing * 4},
            {x: staffX + 320, y: y + lineSpacing * 3},
            {x: staffX + 420, y: y + lineSpacing * 2.5}
        ];
        
        fill(255);
        textSize(30);
        for (let note of notePositions) {
            ellipse(note.x, note.y, 20, 15);
            strokeWeight(2);
            stroke(255);
            line(note.x + 10, note.y, note.x + 10, note.y - 40);
        }
        pop();
    }
    
    function drawUserProgress() {
        let y = height * 0.38;
        push();
        fill(255);
        textSize(24);
        textAlign(CENTER);
        for (let i = 0; i < correctSequence.length; i++) {
            if (i < userInput.length) {
                let isCorrect = userInput[i] === correctSequence[i];
                fill(isCorrect ? '#4ECDC4' : '#FF6B6B');
                let inputDisplay = userInput[i].toUpperCase();
                if (userInput[i] === 'e') inputDisplay = 'Em';
                text(inputDisplay, width/2 - 100 + i * 70, y);
            } else {
                fill(100);
                text('_', width/2 - 100 + i * 70, y);
            }
        }
        pop();
    }

    function keyPressed() {
      if (gameState !== 'playing') return;
      let k = key.toLowerCase();
      if (k === 'd' || k === 'e' || k === 'g') {
        // Play the corresponding note sound
        if (k === 'd' && dSound) {
          dSound.play();
        } else if (k === 'e' && eSound) {
          eSound.play();
        } else if (k === 'g' && gSound) {
          gSound.play();
        }
        
        userInput.push(k);
        if (userInput.length === correctSequence.length) {
          let isCorrect = userInput.every((v, i) => v === correctSequence[i]);
          if (isCorrect) {
            gameState = 'correct';
            startCheering();
          } else {
            userInput = [];
          }
        }
      }
      return false;
    }

    function startCheering() {
      cheering = true;
      cheeringStart = millis();
      if (crowdSound && buzzSound) {
        crowdSound.setVolume(0.5);
        buzzSound.setVolume(0.4);
        crowdSound.loop();
        buzzSound.loop();
      }
    }

    function updateCheering() {
      if (!cheering) return;
      let elapsed = millis() - cheeringStart;
      if (elapsed > 4000) {
        cheering = false;
        cicadaLayers.forEach(c => c.style.transform = 'translateY(0)');
        if (crowdSound && buzzSound) {
          crowdSound.stop();
          buzzSound.stop();
        }
        startSong();
        return;
      }

      cicadaLayers.forEach((c, i) => {
        let speed = 0.02 + Math.random() * 0.02;
        let amplitude = 35 + Math.random() * 15;
        let offset = cheerOffsets[i];
        let y = Math.sin(elapsed * speed + offset) * amplitude;
        c.style.transform = `translateY(${y}px)`;
      });
    }

    function startSong() {
      if (songSound) {
        songSound.setVolume(1);
        songSound.play();
      }

      const line1 = document.getElementById('line1');
      const line2 = document.getElementById('line2');
      const line3 = document.getElementById('line3');
      const line4 = document.getElementById('line4');
      const line5 = document.getElementById('line5');
      const container = document.getElementById('lyricsContainer');
      container.style.opacity = 1;

      // First two lines appear after 1.5s and stay for 17s
      setTimeout(() => {
        line1.classList.add('visible');
        line2.classList.add('visible');
        setTimeout(() => {
          line1.classList.remove('visible');
          line2.classList.remove('visible');
        }, 17000);
      }, 1500);

      // Second section appears 8s after first two disappear and lasts 20s
      setTimeout(() => {
        line3.classList.add('visible');
        line4.classList.add('visible');
        line5.classList.add('visible');
        setTimeout(() => {
          line3.classList.remove('visible');
          line4.classList.remove('visible');
          line5.classList.remove('visible');
          
          // After last lyrics fade, fade out cicadas and chairs
          fadeOutAudience();
        }, 20000);
      }, 1500 + 17000 + 8000);
    }

    function fadeOutAudience() {
      const audienceContainer = document.getElementById('audienceContainer');
      const chairElements = document.querySelectorAll('.chairs');
      const poemContainer = document.getElementById('poemContainer');
      
      // Fade out cicadas and chairs
      cicadaLayers.forEach(c => c.style.opacity = '0');
      chairElements.forEach(ch => ch.style.opacity = '0');
      
      // After fade completes, show poem
      setTimeout(() => {
        poemContainer.style.opacity = '1';
        poemContainer.classList.add('visible');
      }, 2000);
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
    }

    // Link and buzz audio logic
    const visitedPages = new Set(JSON.parse(localStorage.getItem('visitedPages') || '[]'));
    const requiredPages = ['face', 'skin', 'dark', 'sing'];
    const poetLink = document.getElementById('poetLink');
    const buzzAudio = document.getElementById('buzzAudio');

    function checkAllVisited() {
      const allVisited = requiredPages.every(page => visitedPages.has(page));
      if (allVisited) {
        poetLink.classList.add('unlocked');
      }
    }

    // Add buzzing only to links without the no-buzz class
    document.querySelectorAll('.hover-word').forEach(link => {
      if (!link.classList.contains('no-buzz')) {
        link.addEventListener('mouseenter', () => {
          buzzAudio.currentTime = 0;
          buzzAudio.play();
        });
        link.addEventListener('mouseleave', () => {
          buzzAudio.pause();
          buzzAudio.currentTime = 0;
        });
      }

      // Track visited pages
      link.addEventListener('click', function() {
        const page = this.getAttribute('data-page');
        visitedPages.add(page);
        localStorage.setItem('visitedPages', JSON.stringify([...visitedPages]));
        checkAllVisited();
      });
    });

    // Check if all pages have been visited on load
    checkAllVisited();
  </script>
  
</body>
</html>